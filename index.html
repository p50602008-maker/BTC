<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BTC Bot Control Panel (TG)</title>
  <style>
    :root{
      --bg:#0b1220; --card:#101a33; --card2:#0f1830; --text:#e8eeff; --muted:#9fb0d0;
      --line:#203055; --ok:#25d366; --warn:#ffcc00; --bad:#ff4d4f; --btn:#2d6cdf;
    }
    *{box-sizing:border-box;font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
    body{margin:0;background:linear-gradient(180deg,#070b14,#0b1220);color:var(--text);}
    header{position:sticky;top:0;backdrop-filter: blur(10px);background:rgba(11,18,32,.8);border-bottom:1px solid var(--line);z-index:10}
    .wrap{max-width:1120px;margin:0 auto;padding:16px;}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between;}
    .brand{display:flex;gap:10px;align-items:center;}
    .dot{width:10px;height:10px;border-radius:50%;}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px;}
    .grid{display:grid;grid-template-columns: 1.1fr .9fr;gap:12px;margin-top:12px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }
    .card{background:linear-gradient(180deg,var(--card),var(--card2));border:1px solid var(--line);border-radius:16px;padding:14px;}
    .title{font-weight:700;font-size:14px;margin:0 0 10px;}
    .sub{color:var(--muted);font-size:12px;}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;}
    @media (max-width: 980px){ .kpis{grid-template-columns:repeat(2,1fr);} }
    .kpi{border:1px solid var(--line);border-radius:14px;padding:12px;background:rgba(255,255,255,.02);}
    .kpi .v{font-size:18px;font-weight:800;margin-top:6px;}
    .btn{cursor:pointer;border:1px solid var(--line);background:rgba(255,255,255,.03);color:var(--text);
      padding:10px 12px;border-radius:12px;font-weight:700;}
    .btn.primary{background:var(--btn);border-color:#2a5bc2;}
    .btn.good{background:rgba(37,211,102,.12);border-color:rgba(37,211,102,.3);}
    .btn.bad{background:rgba(255,77,79,.12);border-color:rgba(255,77,79,.35);}
    .btn:active{transform:translateY(1px);}
    .btnrow{display:flex;gap:10px;flex-wrap:wrap;}
    input,select,textarea{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      background:rgba(255,255,255,.02);color:var(--text);outline:none;
    }
    textarea{min-height:84px;resize:vertical;}
    table{width:100%;border-collapse:collapse;}
    th,td{border-bottom:1px solid var(--line);padding:10px 8px;text-align:left;font-size:13px;}
    th{color:var(--muted);font-weight:700;}
    .right{display:flex;gap:10px;align-items:center;}
    .small{font-size:12px;color:var(--muted);}
    .tag{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);color:var(--muted);}
    .flex{display:flex;gap:10px;align-items:center;}
    .split{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
    @media (max-width: 980px){ .split{grid-template-columns:1fr;} }
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;}
    .hr{height:1px;background:var(--line);margin:12px 0;}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row">
      <div class="brand">
        <div class="dot" id="statusDot" style="background:var(--warn)"></div>
        <div>
          <div style="font-weight:900;letter-spacing:.2px">BTC自動交易機器人 · TG 控制面板</div>
          <div class="sub">Sprint1（前端雛形）— Web Panel → Cloudflare Worker → Telegram</div>
        </div>
      </div>
      <div class="right">
        <span class="pill" id="envPill">BingX · Spot · Always-on</span>
        <button class="btn" id="btnReset">重置假資料</button>
      </div>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <div class="row">
      <div>
        <div class="title">總覽</div>
        <div class="sub">目前：<span id="runState" class="tag">UNKNOWN</span>　最後心跳：<span id="lastBeat" class="mono small">—</span></div>
      </div>
      <div class="btnrow">
        <button class="btn good" id="btnRun">啟動</button>
        <button class="btn bad" id="btnPause">暫停</button>
        <button class="btn" id="btnPing">心跳測試</button>
      </div>
    </div>

    <div class="hr"></div>

    <div class="kpis">
      <div class="kpi">
        <div class="small">今日收益 (USDT)</div>
        <div class="v" id="kpiDay">0.00</div>
      </div>
      <div class="kpi">
        <div class="small">本月收益 (USDT)</div>
        <div class="v" id="kpiMonth">0.00</div>
      </div>
      <div class="kpi">
        <div class="small">活躍策略數</div>
        <div class="v" id="kpiBots">0</div>
      </div>
      <div class="kpi">
        <div class="small">最近事件</div>
        <div class="v" id="kpiEvents">0</div>
      </div>
    </div>
  </div>

  <div class="grid">
    <!-- Left: Instances -->
    <div class="card">
      <div class="row">
        <div>
          <div class="title">策略實例（常駐）</div>
          <div class="sub">先做「現貨網格」版本；後面再擴充 DCA / Trend / Breakout</div>
        </div>
        <button class="btn primary" id="btnAdd">＋新增實例</button>
      </div>

      <div style="margin-top:10px;overflow:auto;">
        <table id="botTable">
          <thead>
            <tr>
              <th>名稱</th>
              <th>交易對</th>
              <th>類型</th>
              <th>狀態</th>
              <th>上下界</th>
              <th>網格</th>
              <th>每格</th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="hr"></div>
      <div class="sub">點「編輯」可調參（目前前端保存；之後會改成送到你的後端）</div>
    </div>

    <!-- Right: Commands + Settings -->
    <div class="card">
      <div class="title">指令中心（送到 TG / 中轉）</div>
      <div class="sub">已改成：面板會呼叫 Worker <span class="mono">/cmd</span>，然後推送到你的 TG。</div>

      <div class="hr"></div>

      <label class="small">快速指令</label>
      <div class="btnrow" style="margin-top:8px;">
        <button class="btn" data-cmd="/status">/status</button>
        <button class="btn" data-cmd="/pause">/pause</button>
        <button class="btn" data-cmd="/resume">/resume</button>
        <button class="btn" data-cmd="/bots">/bots</button>
      </div>

      <div style="margin-top:10px;">
        <label class="small">自訂指令</label>
        <textarea id="cmdText" class="mono" placeholder="/set GRID-01 upper=72000 lower=64000 grids=35 per=10"></textarea>
        <div class="btnrow" style="margin-top:8px;">
          <button class="btn primary" id="btnSend">送出</button>
          <button class="btn" id="btnClearCmd">清空</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="title" style="margin-top:0">連線設定</div>
      <div class="split">
        <div>
          <label class="small">API / Webhook Base URL</label>
          <input id="apiBase" class="mono" placeholder="例如：https://xxx.workers.dev" />
        </div>
        <div>
          <label class="small">Telegram Chat ID（推播用，可空）</label>
          <input id="chatId" class="mono" placeholder="例如：1632599756" />
        </div>
      </div>

      <div style="margin-top:10px;">
        <label class="small">Panel Secret（對應 Worker 的 PANEL_SECRET）</label>
        <input id="panelSecret" class="mono" placeholder="例如：my-super-secret-2026" />
        <div class="small" style="margin-top:6px;">
          這個是用來避免別人亂打你的 <span class="mono">/cmd</span>。請填 Worker 上設定的同一串。
        </div>
      </div>

      <div class="btnrow" style="margin-top:10px;">
        <button class="btn" id="btnSaveSettings">儲存設定</button>
      </div>

      <div class="hr"></div>

      <div class="title">指令歷史 / 回應</div>
      <div id="log" style="max-height:260px;overflow:auto;border:1px solid var(--line);border-radius:12px;padding:10px;background:rgba(0,0,0,.12)"></div>
    </div>
  </div>
</div>

<!-- Modal -->
<div id="modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);backdrop-filter:blur(6px);align-items:center;justify-content:center;padding:16px;">
  <div class="card" style="max-width:720px;width:100%;">
    <div class="row">
      <div class="title" id="mTitle" style="margin:0;">新增/編輯實例</div>
      <button class="btn" id="mClose">關閉</button>
    </div>
    <div class="hr"></div>

    <div class="split">
      <div>
        <label class="small">名稱</label>
        <input id="mName" placeholder="GRID-01" />
      </div>
      <div>
        <label class="small">交易對</label>
        <input id="mSymbol" placeholder="BTC-USDT" />
      </div>
    </div>

    <div class="split" style="margin-top:10px;">
      <div>
        <label class="small">策略類型</label>
        <select id="mType">
          <option value="GRID">GRID（現貨網格）</option>
          <option value="DCA" disabled>DCA（後續）</option>
          <option value="TREND" disabled>Trend（後續）</option>
        </select>
      </div>
      <div>
        <label class="small">狀態</label>
        <select id="mState">
          <option value="RUNNING">RUNNING</option>
          <option value="PAUSED">PAUSED</option>
        </select>
      </div>
    </div>

    <div class="split" style="margin-top:10px;">
      <div>
        <label class="small">下界 lower</label>
        <input id="mLower" type="number" step="0.01" placeholder="64000" />
      </div>
      <div>
        <label class="small">上界 upper</label>
        <input id="mUpper" type="number" step="0.01" placeholder="72000" />
      </div>
    </div>

    <div class="split" style="margin-top:10px;">
      <div>
        <label class="small">網格數 grids</label>
        <input id="mGrids" type="number" step="1" placeholder="35" />
      </div>
      <div>
        <label class="small">每格金額 perGrid (USDT)</label>
        <input id="mPer" type="number" step="0.01" placeholder="10" />
      </div>
    </div>

    <div class="hr"></div>
    <div class="btnrow">
      <button class="btn primary" id="mSave">保存</button>
      <button class="btn bad" id="mDelete">刪除</button>
    </div>
  </div>
</div>

<script>
  const LS_KEY = "btc_panel_v1";
  const nowISO = () => new Date().toISOString().replace("T"," ").slice(0,19);

  function load() {
    const raw = localStorage.getItem(LS_KEY);
    if (raw) return JSON.parse(raw);
    return {
      settings: { apiBase:"", chatId:"", panelSecret:"" },
      runtime: { runState:"PAUSED", lastBeat:null, dayPnl:0, monthPnl:0 },
      bots: [
        { id: crypto.randomUUID(), name:"GRID-01", symbol:"BTC-USDT", type:"GRID", state:"RUNNING", lower:64000, upper:72000, grids:35, per:10 },
      ],
      logs: []
    };
  }
  function save(db){ localStorage.setItem(LS_KEY, JSON.stringify(db)); }

  let db = load();
  let editingId = null;

  function render(){
    const dot = document.getElementById("statusDot");
    const runState = db.runtime.runState;
    document.getElementById("runState").textContent = runState;
    document.getElementById("runState").className = "tag";
    document.getElementById("lastBeat").textContent = db.runtime.lastBeat || "—";
    dot.style.background = runState === "RUNNING" ? "var(--ok)" : "var(--warn)";

    document.getElementById("kpiDay").textContent = Number(db.runtime.dayPnl).toFixed(2);
    document.getElementById("kpiMonth").textContent = Number(db.runtime.monthPnl).toFixed(2);
    document.getElementById("kpiBots").textContent = db.bots.length;
    document.getElementById("kpiEvents").textContent = db.logs.length;

    document.getElementById("apiBase").value = db.settings.apiBase || "";
    document.getElementById("chatId").value = db.settings.chatId || "";
    document.getElementById("panelSecret").value = db.settings.panelSecret || "";

    const tb = document.querySelector("#botTable tbody");
    tb.innerHTML = "";
    db.bots.forEach(b=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${escapeHtml(b.name)}</td>
        <td class="mono">${escapeHtml(b.symbol)}</td>
        <td>${escapeHtml(b.type)}</td>
        <td><span class="tag">${escapeHtml(b.state)}</span></td>
        <td class="mono">${Number(b.lower).toFixed(0)} ~ ${Number(b.upper).toFixed(0)}</td>
        <td class="mono">${b.grids}</td>
        <td class="mono">${Number(b.per).toFixed(2)}</td>
        <td><button class="btn" data-edit="${b.id}">編輯</button></td>
      `;
      tb.appendChild(tr);
    });

    const log = document.getElementById("log");
    log.innerHTML = db.logs.slice().reverse().map(x=>`
      <div style="margin-bottom:8px;">
        <div class="small mono">${escapeHtml(x.ts)} · <span class="tag">${escapeHtml(x.type)}</span></div>
        <div class="mono" style="white-space:pre-wrap">${escapeHtml(x.msg)}</div>
      </div>
    `).join("") || `<div class="small">（尚無）</div>`;
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function addLog(type,msg){
    db.logs.push({ ts: nowISO(), type, msg });
    if (db.logs.length>250) db.logs = db.logs.slice(-250);
    save(db); render();
  }

  // ===== Runtime buttons =====
  document.getElementById("btnRun").onclick = async () => {
  db.runtime.runState = "RUNNING";
  db.runtime.lastBeat = nowISO();
  addLog("SYSTEM","Run => RUNNING");
  await pushStateToWorker_();
};

document.getElementById("btnPause").onclick = async () => {
  db.runtime.runState = "PAUSED";
  db.runtime.lastBeat = nowISO();
  addLog("SYSTEM","Pause => PAUSED");
  await pushStateToWorker_();
};

document.getElementById("btnPing").onclick = async () => {
  db.runtime.lastBeat = nowISO();
  addLog("PING","Heartbeat OK");
  await pushStateToWorker_();
};


  document.getElementById("btnReset").onclick = () => {
    localStorage.removeItem(LS_KEY);
    db = load();
    addLog("SYSTEM","Reset demo data");
  };

  // ===== Settings =====
  document.getElementById("btnSaveSettings").onclick = () => {
    db.settings.apiBase = document.getElementById("apiBase").value.trim();
    db.settings.chatId = document.getElementById("chatId").value.trim();
    db.settings.panelSecret = document.getElementById("panelSecret").value.trim();
    save(db); addLog("SYSTEM","Settings saved");
  };
async function pushStateToWorker_() {
  const API_BASE = (db.settings.apiBase || "").trim();
  const SECRET = (db.settings.panelSecret || "").trim();
  if (!API_BASE || !SECRET) return;

  const endpoint = API_BASE.replace(/\/$/,"") + "/state";
  const payload = {
    secret: SECRET,
    runtime: db.runtime,
    bots: db.bots.map(b => ({
      name: b.name, symbol: b.symbol, type: b.type, state: b.state,
      lower: b.lower, upper: b.upper, grids: b.grids, per: b.per
    }))
  };

  try {
    const res = await fetch(endpoint, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    // 不要太吵，只在錯誤時記 log
    if (!res.ok) {
      const t = await res.text();
      addLog("RESP", `pushState HTTP ${res.status}\n${t}`);
    }
  } catch(e) {
    addLog("RESP", "pushState 失敗：" + (e?.message || String(e)));
  }
}

  // ===== Commands =====
  async function sendCommand(cmd){
    cmd = (cmd||"").trim();
    if (!cmd) return;

    addLog("CMD", cmd);

    const API_BASE = (db.settings.apiBase || "").trim();
    const SECRET = (db.settings.panelSecret || "").trim();

    if (!API_BASE) {
      addLog("RESP", "⚠️ 尚未設定 API Base URL（請到 Settings 填 https://xxx.workers.dev）");
      return;
    }
    if (!SECRET) {
      addLog("RESP", "⚠️ 尚未設定 Panel Secret（請到 Settings 填 Worker 的 PANEL_SECRET）");
      return;
    }

    const endpoint = API_BASE.replace(/\/$/,"") + "/cmd";

    try {
      const res = await fetch(endpoint, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          cmd,
          chatId: (db.settings.chatId || "").trim(), // 可空
          secret: SECRET
        })
      });

      const text = await res.text(); // 用 text 方便看錯誤（403/404/CORS）
      addLog("RESP", `HTTP ${res.status}\n${text}`);

    } catch (e) {
      addLog("RESP", "❌ fetch 失敗：" + (e?.message || String(e)));
    }
  }

  document.querySelectorAll("[data-cmd]").forEach(b=>{
    b.onclick = () => sendCommand(b.getAttribute("data-cmd"));
  });
  document.getElementById("btnSend").onclick = () => sendCommand(document.getElementById("cmdText").value);
  document.getElementById("btnClearCmd").onclick = () => { document.getElementById("cmdText").value=""; };

  // ===== Modal for bots =====
  const modal = document.getElementById("modal");
  function openModal(bot){
    modal.style.display="flex";
    editingId = bot?.id ?? null;
    document.getElementById("mTitle").textContent = editingId ? "編輯實例" : "新增實例";

    document.getElementById("mName").value = bot?.name ?? "";
    document.getElementById("mSymbol").value = bot?.symbol ?? "BTC-USDT";
    document.getElementById("mType").value = bot?.type ?? "GRID";
    document.getElementById("mState").value = bot?.state ?? "RUNNING";
    document.getElementById("mLower").value = bot?.lower ?? 64000;
    document.getElementById("mUpper").value = bot?.upper ?? 72000;
    document.getElementById("mGrids").value = bot?.grids ?? 35;
    document.getElementById("mPer").value = bot?.per ?? 10;

    document.getElementById("mDelete").style.display = editingId ? "inline-block":"none";
  }
  function closeModal(){ modal.style.display="none"; editingId=null; }
  document.getElementById("mClose").onclick = closeModal;
  modal.addEventListener("click",(e)=>{ if(e.target===modal) closeModal(); });

  document.getElementById("btnAdd").onclick = () => openModal(null);

  document.addEventListener("click",(e)=>{
    const id = e.target?.getAttribute?.("data-edit");
    if (!id) return;
    const bot = db.bots.find(x=>x.id===id);
    if (bot) openModal(bot);
  });

  document.getElementById("mSave").onclick = () => {
    const bot = {
      id: editingId || crypto.randomUUID(),
      name: document.getElementById("mName").value.trim() || "GRID-NEW",
      symbol: document.getElementById("mSymbol").value.trim() || "BTC-USDT",
      type: document.getElementById("mType").value,
      state: document.getElementById("mState").value,
      lower: Number(document.getElementById("mLower").value || 0),
      upper: Number(document.getElementById("mUpper").value || 0),
      grids: Number(document.getElementById("mGrids").value || 0),
      per: Number(document.getElementById("mPer").value || 0),
    };

    if (bot.lower<=0 || bot.upper<=0 || bot.upper<=bot.lower || bot.grids<=0 || bot.per<=0){
      alert("參數不合法：請確認 upper>lower、grids/per 都>0");
      return;
    }

    const idx = db.bots.findIndex(x=>x.id===bot.id);
    if (idx>=0) db.bots[idx]=bot; else db.bots.unshift(bot);
    save(db);
    addLog("BOT", (idx>=0?"Update ":"Create ") + bot.name);
    await pushStateToWorker_();
    closeModal(); render();
  };

  document.getElementById("mDelete").onclick = () => {
    if (!editingId) return;
    const bot = db.bots.find(x=>x.id===editingId);
    if (!bot) return;
    if (!confirm("確定刪除 " + bot.name + " ?")) return;
    db.bots = db.bots.filter(x=>x.id!==editingId);
    save(db);
    addLog("BOT","Delete " + bot.name);
    await pushStateToWorker_();
    closeModal(); render();
  };

  // init
  render();
</script>
</body>
</html>



